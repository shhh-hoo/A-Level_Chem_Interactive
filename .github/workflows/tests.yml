name: Tests

on:
  push:
  pull_request:

jobs:
  reaction-map-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Run reaction path tests
        run: node tests/paths.test.js

      - name: Run structure tests
        run: node tests/structure.test.js

      - name: Run database schema tests
        run: node tests/db.test.js

  supabase-db-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Set up Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: "latest"

      - name: Start local Supabase stack (full)
        run: supabase start

      - name: Reset database (migrations + seed)
        run: supabase db reset

      - name: Reset database again (seed idempotency)
        run: supabase db reset

      - name: Lint database schema
        run: supabase db lint --level error

      - name: Run database tests
        run: |
          if [ -d supabase/tests ]; then
            supabase test db
          else
            echo "No supabase/tests directory found; skipping pgTAP tests."
          fi

      - name: Run Edge Functions tests
        run: bash scripts/test-edge.sh
