name: Tests

on:
  push:
  pull_request:

jobs:
  reaction-map-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Run reaction path tests
        run: node tests/paths.test.js

      - name: Run structure tests
        run: node tests/structure.test.js

      - name: Run database schema tests
        run: node tests/db.test.js

  supabase-db-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Set up Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: 'latest'

      - name: Init local Supabase stack
        run: supabase init

      - name: Start local Supabase stack
        run: supabase db start

      - name: Reset database (migrations + seed)
        run: supabase db reset

      - name: Reset database again (seed idempotency)
        run: supabase db reset

      - name: Lint database schema
        run: supabase db lint --level error

      - name: Run database tests
        run: |
          if [ -d supabase/tests ]; then
            supabase test db
          else
            echo "No supabase/tests directory found; skipping pgTAP tests."
          fi

      - name: Capture Supabase local credentials
        id: supabase-creds
        run: |
          STATUS_JSON="$(supabase status -o json)"
          STATUS_JSON="$STATUS_JSON" node -e "const s=JSON.parse(process.env.STATUS_JSON); const api=s.api_url ?? s.API_URL ?? s['API URL']; const service=s.service_role_key ?? s.SERVICE_ROLE_KEY ?? s['service_role key'] ?? s['service role key']; if(!api||!service){ throw new Error('Missing api/service role key in supabase status'); } console.log(`SUPABASE_URL=${api}`); console.log(`SUPABASE_SERVICE_ROLE_KEY=${service}`);" >> "$GITHUB_OUTPUT"

      - name: Start edge functions
        run: |
          cat <<EOF > supabase/.env.edge
          SUPABASE_URL=${{ steps.supabase-creds.outputs.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY=${{ steps.supabase-creds.outputs.SUPABASE_SERVICE_ROLE_KEY }}
          SERVER_SALT=edge-test-salt-${{ github.run_id }}
          EOF
          supabase functions serve --env-file supabase/.env.edge --no-verify-jwt > supabase/functions.log 2>&1 &
          sleep 5

      - name: Run edge function tests
        env:
          SUPABASE_URL: ${{ steps.supabase-creds.outputs.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ steps.supabase-creds.outputs.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_FUNCTIONS_URL: ${{ steps.supabase-creds.outputs.SUPABASE_URL }}/functions/v1
        run: deno test supabase/functions/tests/edge-functions.test.ts --allow-env --allow-net --allow-read
